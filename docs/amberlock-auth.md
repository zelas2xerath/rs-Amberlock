# amberlock-auth

**æœ¬åœ°å¯†ç ä¿é™©åº“æ¨¡å— - åŸºäº Argon2id + DPAPI**

æœ¬ crate æä¾›å®‰å…¨çš„æœ¬åœ°å¯†ç å­˜å‚¨å’ŒéªŒè¯åŠŸèƒ½ï¼Œç”¨äº AmberLock çš„è§£é”è®¤è¯æœºåˆ¶ã€‚

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è§ˆ

### âœ… æ ¸å¿ƒç‰¹æ€§

1. **å¯†ç å“ˆå¸Œç®—æ³• - Argon2id**
    - âœ… å†…å­˜å›°éš¾ï¼ˆMemory-hardï¼‰ï¼šæŠµæŠ— GPU/ASIC æš´åŠ›ç ´è§£
    - âœ… ä¾§ä¿¡é“æŠµæŠ—ï¼šé˜²å¾¡ç¼“å­˜æ—¶åºæ”»å‡»
    - âœ… OWASP æ¨èå‚æ•°ï¼š
        - å†…å­˜æˆæœ¬ï¼š19 MiB
        - æ—¶é—´æˆæœ¬ï¼š2 æ¬¡è¿­ä»£
        - å¹¶è¡Œåº¦ï¼š1
    - âœ… éšæœºç›ï¼ˆ128 ä½ï¼‰

2. **ç³»ç»Ÿçº§åŠ å¯† - Windows DPAPI**
    - âœ… å¯†é’¥ç»‘å®šåˆ°å½“å‰ç”¨æˆ·
    - âœ… å¯†é’¥ç»‘å®šåˆ°å½“å‰æœºå™¨
    - âœ… æ— éœ€ç”¨æˆ·ç®¡ç†å¯†é’¥
    - âœ… æ”¯æŒè·¨ä¼šè¯æŒä¹…åŒ–

3. **å®‰å…¨é˜²æŠ¤æªæ–½**
    - âœ… å¸¸æ•°æ—¶é—´æ¯”è¾ƒï¼ˆé˜²å¾¡è®¡æ—¶æ”»å‡»ï¼‰
    - âœ… éªŒè¯å¤±è´¥é€€é¿ï¼ˆ500ms å»¶è¿Ÿï¼‰
    - âœ… æ•æ„Ÿæ•°æ®é›¶åŒ–ï¼ˆå†…å­˜æ¸…ç†ï¼‰
    - âœ… æ¨¡ç³ŠåŒ–é”™è¯¯ä¿¡æ¯

---

## ğŸ¯ æ ¸å¿ƒ API

### 1. åˆ›å»ºå¯†ç ä¿é™©åº“

```rust
use amberlock_auth::create_vault;
use std::fs;

// åˆ›å»ºä¿é™©åº“ï¼ˆDPAPI åŠ å¯†ï¼‰
let vault_blob = create_vault("my_secure_password")?;

// æŒä¹…åŒ–åˆ°æ–‡ä»¶
fs::write("vault.bin", &vault_blob)?;
```

### 2. éªŒè¯å¯†ç 

```rust
use amberlock_auth::verify_password;
use std::fs;

// åŠ è½½ä¿é™©åº“
let vault_blob = fs::read("vault.bin")?;

// éªŒè¯å¯†ç 
match verify_password(&vault_blob, "user_input_password")? {
    true => println!("âœ… å¯†ç æ­£ç¡® - å…è®¸è§£é”"),
    false => println!("âŒ å¯†ç é”™è¯¯ - æ‹’ç»è®¿é—®"),
}
```

### 3. åŠ è½½ä¿é™©åº“å…ƒæ•°æ®

```rust
use amberlock_auth::load_vault;
use std::fs;

let vault_blob = fs::read("vault.bin")?;
let vault = load_vault(&vault_blob)?;

println!("ä¿é™©åº“ç‰ˆæœ¬: {}", vault.version);
println!("Argon2 å‚æ•°: {}", vault.params);
```

---

## ğŸ”’ å®‰å…¨æ¶æ„

### æ•°æ®æµå›¾

```
ç”¨æˆ·å¯†ç  (æ˜æ–‡)
    â†“
Argon2id å“ˆå¸Œ (19 MiB å†…å­˜, 2 è¿­ä»£)
    â†“
VaultBlob { version, salt, params, hash }
    â†“
JSON åºåˆ—åŒ–
    â†“
DPAPI åŠ å¯† (CryptProtectData)
    â†“
vault.bin (å¯†æ–‡æ–‡ä»¶)
```

### éªŒè¯æµç¨‹

```
vault.bin (å¯†æ–‡æ–‡ä»¶)
    â†“
DPAPI è§£å¯† (CryptUnprotectData)
    â†“
JSON ååºåˆ—åŒ– â†’ VaultBlob
    â†“
Argon2id éªŒè¯ (å¸¸æ•°æ—¶é—´æ¯”è¾ƒ)
    â†“
æˆåŠŸ/å¤±è´¥ (å¤±è´¥æ—¶ 500ms é€€é¿)
```

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§è¯¦è§£

### 1. Argon2id å‚æ•°é€‰æ‹©

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| ç®—æ³• | Argon2id | æ··åˆæ¨¡å¼ï¼ˆæŠµæŠ— GPU å’Œä¾§ä¿¡é“æ”»å‡»ï¼‰ |
| å†…å­˜æˆæœ¬ | 19 MiB | OWASP æ¨èçš„æœ€ä½å®‰å…¨å€¼ |
| æ—¶é—´æˆæœ¬ | 2 è¿­ä»£ | å¹³è¡¡å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒ |
| å¹¶è¡Œåº¦ | 1 | æœ€å¤§åŒ–å†…å­˜å›°éš¾åº¦ |
| ç›é•¿åº¦ | 16 å­—èŠ‚ | å¯†ç å­¦å®‰å…¨éšæœºæ•°ç”Ÿæˆ |

**ä¸ºä»€ä¹ˆé€‰æ‹© Argon2idï¼Ÿ**
- âœ… èµ¢å¾— Password Hashing Competition (2015)
- âœ… RFC 9106 æ ‡å‡†åŒ–ç®—æ³•
- âœ… åŒæ—¶æŠµæŠ—ä¾§ä¿¡é“æ”»å‡»å’Œ GPU ç ´è§£

### 2. DPAPI ä¿æŠ¤æœºåˆ¶

**å·¥ä½œåŸç†**ï¼š
- Windows ä½¿ç”¨ DPAPI Master Key åŠ å¯†ä¿é™©åº“
- Master Key ç»‘å®šåˆ°ï¼š
    - ç”¨æˆ·ç™»å½•å‡­æ®ï¼ˆå¯†ç /PINï¼‰
    - æœºå™¨ SIDï¼ˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
- æ•°æ®ä»…èƒ½åœ¨åŒä¸€ç”¨æˆ·+åŒä¸€æœºå™¨ä¸Šè§£å¯†

**ä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€ç”¨æˆ·è®°å¿†é¢å¤–å¯†é’¥
- âœ… ç³»ç»Ÿçº§å¯†é’¥ç®¡ç†ï¼ˆé€æ˜åŒ–ï¼‰
- âœ… é˜²å¾¡ç¦»çº¿æ”»å‡»ï¼ˆéœ€è¦ç™»å½•å‡­æ®ï¼‰

**é™åˆ¶**ï¼š
- âš ï¸ é‡è£…ç³»ç»Ÿå Master Key å¤±æ•ˆ
- âš ï¸ ç®¡ç†å‘˜å¯ä½¿ç”¨æ¢å¤ä»£ç†è§£å¯†
- âš ï¸ ä¸é˜²å¾¡æœ¬æœºç®¡ç†å‘˜æ”»å‡»

### 3. é˜²å¾¡è®¡æ—¶æ”»å‡»

**å¨èƒæ¨¡å‹**ï¼š
æ”»å‡»è€…é€šè¿‡æµ‹é‡éªŒè¯å“åº”æ—¶é—´ï¼Œæ¨æ–­å¯†ç éƒ¨åˆ†æ­£ç¡®æ€§ã€‚

**é˜²å¾¡æªæ–½**ï¼š
```rust
// é”™è¯¯å¯†ç éªŒè¯æµç¨‹
å¯†ç é”™è¯¯ â†’ å¸¸æ•°æ—¶é—´æ¯”è¾ƒ â†’ ç­‰å¾…è‡³ 500ms â†’ è¿”å› false
```

**ä»£ç å®ç°**ï¼š
```rust
fn apply_backoff(start: Instant) {
    let elapsed = start.elapsed();
    let target = Duration::from_millis(500);
    
    if elapsed < target {
        std::thread::sleep(target - elapsed);
    }
}
```

### 4. é”™è¯¯ä¿¡æ¯æ¨¡ç³ŠåŒ–

**ä¸å®‰å…¨åšæ³•**ï¼ˆæ³„éœ²ä¿¡æ¯ï¼‰ï¼š
```rust
// âŒ é”™è¯¯ç¤ºä¾‹
if dpapi_decrypt_failed {
    return Err("DPAPI è§£å¯†å¤±è´¥");  // æ³„éœ²äº†ä¿é™©åº“å®Œæ•´æ€§
}
if password_wrong {
    return Err("å¯†ç é”™è¯¯");        // æ³„éœ²äº†å¯†ç éªŒè¯å¤±è´¥åŸå› 
}
```

**å®‰å…¨åšæ³•**ï¼ˆæ¨¡ç³ŠåŒ–ï¼‰ï¼š
```rust
// âœ… æ­£ç¡®ç¤ºä¾‹
match verify_password(&blob, password) {
    Ok(false) => "è®¤è¯å¤±è´¥",   // ä¸åŒºåˆ† DPAPI å¤±è´¥ vs å¯†ç é”™è¯¯
    Err(_) => "è®¤è¯å¤±è´¥",      // ç»Ÿä¸€é”™è¯¯æ¶ˆæ¯
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å…¸å‹åœºæ™¯ï¼ˆIntel i5, 16GB RAMï¼‰

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| åˆ›å»ºä¿é™©åº“ | ~200ms | Argon2 è®¡ç®— + DPAPI åŠ å¯† |
| éªŒè¯æ­£ç¡®å¯†ç  | ~200ms | DPAPI è§£å¯† + Argon2 éªŒè¯ |
| éªŒè¯é”™è¯¯å¯†ç  | ~700ms | Argon2 éªŒè¯ + 500ms é€€é¿ |

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä¸è¦åœ¨çƒ­è·¯å¾„è°ƒç”¨**
    - âŒ ä¸è¦åœ¨å¾ªç¯ä¸­éªŒè¯å¯†ç 
    - âœ… ä»…åœ¨ç”¨æˆ·ä¸»åŠ¨è§£é”æ—¶è°ƒç”¨

2. **ç¼“å­˜éªŒè¯ç»“æœ**ï¼ˆå¯é€‰ï¼‰
   ```rust
   // æˆåŠŸéªŒè¯åï¼Œåœ¨ä¼šè¯ä¸­ç¼“å­˜çŠ¶æ€
   if verify_password(&blob, password)? {
       session.authenticated = true;
   }
   ```

3. **å¼‚æ­¥å¤„ç†**ï¼ˆGUI åº”ç”¨ï¼‰
   ```rust
   // é¿å…é˜»å¡ UI çº¿ç¨‹
   tokio::spawn(async move {
       let is_valid = verify_password(&blob, password)?;
       // æ›´æ–° UI çŠ¶æ€
   });
   ```

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

```bash
cargo test --lib
```

**æµ‹è¯•é¡¹**ï¼š
- âœ… ä¿é™©åº“åˆ›å»ºå’ŒéªŒè¯
- âœ… DPAPI åŠ å¯†/è§£å¯†å¾ªç¯
- âœ… å¸¸æ•°æ—¶é—´æ¯”è¾ƒ
- âœ… é€€é¿å»¶è¿Ÿæœºåˆ¶
- âœ… ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥

### é›†æˆæµ‹è¯•

```bash
cargo test --test integration
```

**æµ‹è¯•åœºæ™¯**ï¼š
- âœ… å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºâ†’ä¿å­˜â†’åŠ è½½â†’éªŒè¯ï¼‰
- âœ… å¤šå¯†ç ç‹¬ç«‹æ€§
- âœ… Unicode å¯†ç æ”¯æŒ
- âœ… å¤§å°å†™æ•æ„Ÿæ€§
- âœ… ç©ºå¯†ç /è¶…é•¿å¯†ç 
- âœ… ä¿é™©åº“æŸåæ£€æµ‹
- âœ… è®¡æ—¶æ”»å‡»æŠµæŠ—

---

## ğŸš¨ å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. ä¸é˜²å¾¡çš„æ”»å‡»

æœ¬æ¨¡å—**æ— æ³•é˜²å¾¡**ä»¥ä¸‹å¨èƒï¼š

| å¨èƒ | åŸå›  |
|------|------|
| æœ¬æœºç®¡ç†å‘˜ | å¯è¯»å–è¿›ç¨‹å†…å­˜ã€è°ƒè¯•åº”ç”¨ã€ä½¿ç”¨ DPAPI æ¢å¤ä»£ç† |
| ç¦»çº¿æš´åŠ›ç ´è§£ï¼ˆDPAPI æ³„éœ²ï¼‰ | éœ€è¦ç”¨æˆ·ç™»å½•å‡­æ® + æœºå™¨ SIDï¼Œéš¾åº¦æé«˜ |
| å†…å­˜è½¬å‚¨æ”»å‡» | å¯†ç æ˜æ–‡çŸ­æš‚å­˜åœ¨äºå†…å­˜ä¸­ |
| é”®ç›˜è®°å½•å™¨ | ç”¨æˆ·è¾“å…¥æ—¶è¢«æˆªè· |

### 2. ä½¿ç”¨å»ºè®®

#### âœ… æ¨èåšæ³•

```rust
// 1. åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºä¿é™©åº“
let vault = create_vault(&initial_password)?;
fs::write(vault_path, vault)?;

// 2. éªŒè¯åç«‹å³æ¸…é™¤å¯†ç 
{
    let password = get_user_input();
    let is_valid = verify_password(&vault, &password)?;
    drop(password); // å°½å¿«æ¸…é™¤
    
    if is_valid {
        // æˆæƒæ“ä½œ
    }
}

// 3. é™åˆ¶éªŒè¯å°è¯•æ¬¡æ•°
const MAX_ATTEMPTS: u32 = 5;
let mut attempts = 0;

loop {
    attempts += 1;
    if attempts > MAX_ATTEMPTS {
        return Err("è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°");
    }
    
    if verify_password(&vault, &input)? {
        break;
    }
}
```

#### âŒ é”™è¯¯åšæ³•

```rust
// âŒ ä¸è¦å°†å¯†ç å­˜å‚¨åœ¨é™æ€å˜é‡ä¸­
static PASSWORD: &str = "hardcoded_password"; // æ³„éœ²

// âŒ ä¸è¦è®°å½•å¯†ç åˆ°æ—¥å¿—
println!("ç”¨æˆ·è¾“å…¥å¯†ç : {}", password); // å®‰å…¨é£é™©

// âŒ ä¸è¦åœ¨é”™è¯¯æ¶ˆæ¯ä¸­åŒ…å«å¯†ç 
Err(format!("å¯†ç  '{}' éªŒè¯å¤±è´¥", password)); // æ³„éœ²
```

### 3. å¯†ç å¼ºåº¦å»ºè®®

è™½ç„¶ Argon2 æä¾›è‰¯å¥½ä¿æŠ¤,ä½†å¼ºå¯†ç ä»ç„¶é‡è¦ï¼š

| å¯†ç ç±»å‹ | ç¤ºä¾‹ | ç ´è§£éš¾åº¦ |
|----------|------|----------|
| å¼±å¯†ç  | `password123` | âš ï¸ ä½ï¼ˆå­—å…¸æ”»å‡»ï¼‰ |
| ä¸­ç­‰å¯†ç  | `MyP@ss2025` | ğŸ”¶ ä¸­ï¼ˆç¬¦å·+æ•°å­—ï¼‰ |
| å¼ºå¯†ç  | `k7#mQ$9pL2&vN@4x` | âœ… é«˜ï¼ˆéšæœº16å­—ç¬¦ï¼‰ |

**æ¨èç­–ç•¥**ï¼š
- æœ€ä½ 12 å­—ç¬¦
- åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç¬¦å·
- é¿å…å¸¸è§è¯å…¸è¯æ±‡
- ä½¿ç”¨å¯†ç ç”Ÿæˆå™¨

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šéªŒè¯æ€»æ˜¯å¤±è´¥

**ç—‡çŠ¶**ï¼š
```rust
assert!(verify_password(&blob, correct_password)?); // å¤±è´¥
```

**å¯èƒ½åŸå› **ï¼š
1. ä¿é™©åº“åœ¨ä¸åŒç”¨æˆ·/æœºå™¨ä¸Šè§£å¯†
2. å¯†ç åŒ…å«éšè—å­—ç¬¦ï¼ˆå¦‚é›¶å®½ç©ºæ ¼ï¼‰
3. å­—ç¬¦ç¼–ç ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// æ£€æŸ¥ DPAPI è§£å¯†æ˜¯å¦æˆåŠŸ
match load_vault(&blob) {
    Ok(vault) => println!("âœ… DPAPI è§£å¯†æˆåŠŸ"),
    Err(e) => println!("âŒ DPAPI è§£å¯†å¤±è´¥: {}", e),
}

// æ‰“å°å¯†ç å­—èŠ‚ï¼ˆè°ƒè¯•ç”¨ï¼‰
println!("å¯†ç å­—èŠ‚: {:?}", password.as_bytes());
```

### é—®é¢˜ 2ï¼šæ€§èƒ½è¿‡æ…¢

**ç—‡çŠ¶**ï¼š
```rust
éªŒè¯å¯†ç è€—æ—¶: 10 ç§’ // è¿œè¶…é¢„æœŸ
```

**å¯èƒ½åŸå› **ï¼š
1. è¿è¡Œåœ¨ä½æ€§èƒ½è®¾å¤‡ï¼ˆå†…å­˜ä¸è¶³ï¼‰
2. å¤šçº¿ç¨‹å¹¶å‘éªŒè¯
3. è™šæ‹Ÿæœº/å®¹å™¨ç¯å¢ƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// é™ä½ Argon2 å‚æ•°ï¼ˆä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼‰
const ARGON2_MEM_COST: u32 = 8192;  // ä» 19456 é™ä½åˆ° 8 MiB
const ARGON2_TIME_COST: u32 = 1;    // ä» 2 é™ä½åˆ° 1
```

### é—®é¢˜ 3ï¼šDPAPI è§£å¯†å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
Error: DPAPI decryption failed (wrong user/machine?)
```

**å¯èƒ½åŸå› **ï¼š
- ä¿é™©åº“åœ¨ä¸åŒæœºå™¨ä¸Šä½¿ç”¨
- ç”¨æˆ·é…ç½®æ–‡ä»¶æŸå
- Windows é‡è£…å Master Key ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```rust
// é‡æ–°åˆ›å»ºä¿é™©åº“
let new_blob = create_vault(&password)?;
fs::write(vault_path, new_blob)?;
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æ ‡å‡†æ–‡æ¡£

- [RFC 9106: Argon2 Memory-Hard Function](https://www.rfc-editor.org/rfc/rfc9106.html)
- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [Microsoft: CryptProtectData](https://learn.microsoft.com/en-us/windows/win32/api/dpapi/nf-dpapi-cryptprotectdata)

### å­¦æœ¯è®ºæ–‡

- Biryukov, A., et al. "Argon2: the memory-hard function for password hashing and other applications" (2015)

### ä»£ç ç¤ºä¾‹

- [Argon2 Rust crate](https://docs.rs/argon2/)
- [Windows-rs DPAPI examples](https://github.com/microsoft/windows-rs)

---

## ğŸ“„ è®¸å¯è¯

MIT OR Apache-2.0

---

**ç»´æŠ¤è€…**: Zelas2Xerath  
**ç‰ˆæœ¬**: 0.1.0  
**æœ€åæ›´æ–°**: 2025-01-01