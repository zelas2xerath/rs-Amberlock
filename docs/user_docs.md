# AmberLock GUI 用户指南

## 🚀 快速开始

### 1. 首次启动

```bash
# 以管理员身份运行（必需）
cargo run --release --bin amberlock-gui

# 或者在 Windows PowerShell 中：
Start-Process cargo -ArgumentList "run --release --bin amberlock-gui" -Verb RunAs
```

**首次启动时会自动：**
- 创建配置文件（`%APPDATA%/amberlock-settings.json`）
- 创建日志文件（`%LOCALAPPDATA%/amberlock-log.ndjson`）
- 创建密码保险库（`%LOCALAPPDATA%/amberlock-vault.bin`，默认密码：`amberlock`）

⚠️ **重要**：首次启动后请立即修改默认密码！

---

## 🎨 界面概览

```
┌─────────────────────────────────────────────────────────┐
│  🔒 AmberLock              👤 SID: S-1-5-21-xxx   ☀️   │
├───────────┬────────────────────────────┬────────────────┤
│           │  📑 文件/目录列表          │  📊 统计信息   │
│  📂 选择  │  ┌──────────────────────┐  │  🔐 锁定操作   │
│  对象     │  │ ☑ C:\test\file1.txt  │  │  📝 操作日志   │
│           │  │ ☑ C:\data\config.json│  │                │
│  🔍 日志  │  │ ☐ C:\docs\secret.doc │  │                │
│  筛选     │  └──────────────────────┘  │                │
└───────────┴────────────────────────────┴────────────────┤
│  ✅ 就绪 - 完整性级别: High | 版本: 2.0.0              │
└─────────────────────────────────────────────────────────┘
```

### 主要区域

1. **左侧边栏**
    - 📂 选择对象：添加文件/文件夹
    - 🔍 日志筛选：搜索历史操作

2. **中央区域**
    - 📑 文件列表：显示已选择的文件/文件夹
    - ☑ 多选复选框：选择要操作的对象

3. **右侧边栏**
    - 📊 统计信息：显示已选对象和操作记录数量
    - 🔐 锁定操作：配置保护模式和级别
    - 📝 操作日志：查看历史操作记录

---

## 📖 功能详解

### 1. 添加文件/文件夹

#### 方法一：使用按钮
1. 点击左侧"添加文件"或"添加文件夹"按钮
2. 在文件选择对话框中选择目标
3. 文件将出现在中央列表中

#### 方法二：拖放（未来版本）
- 直接将文件/文件夹拖入中央列表区域

**支持的路径类型：**
- ✅ 普通文件（`.txt`, `.docx`, `.pdf` 等）
- ✅ 普通文件夹
- ⚠️ 卷根（`C:\`, `D:\` 等）- 需要二次确认

---

### 2. 锁定操作

#### 锁定模式

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| **只读** | 允许读取，禁止写入/删除 | 防止误操作，保持文件可见 |
| **封印** | 尽可能禁止所有访问 | 最高级别保护（需权限） |

#### 完整性级别

| 级别 | 说明 | 权限要求 |
|------|------|---------|
| **Medium** | 标准用户级别 | 无特殊要求 |
| **High** | 管理员级别 | `SeSecurityPrivilege` |
| **System** | 系统级别 | `SeRelabelPrivilege` |

**自动降级规则：**
- 如果选择 `System` 但缺少权限，会自动降级为 `High`
- 状态栏会显示降级提示

#### 高级选项

- **尝试 NR/NX**：尝试应用 No-Read-Up 和 No-Execute-Up 策略
    - ⚠️ 注意：对文件对象不保证生效
    - 默认关闭，仅作为实验性功能

#### 操作步骤

1. 在文件列表中勾选要锁定的对象
2. 在右侧选择锁定模式（只读/封印）
3. 选择完整性级别（Medium/High/System）
4. （可选）勾选"尝试 NR/NX"
5. 点击"🔒 应用上锁"按钮
6. 等待进度完成，查看状态栏结果

**示例输出：**
```
✅ 上锁完成: 10/10 成功 (2 项降级)
```

---

### 3. 解锁操作

#### 操作步骤

1. 在文件列表中勾选要解锁的对象
2. 点击右侧"🔓 解锁"按钮
3. 系统会自动使用保险库密码验证
4. 等待进度完成

**注意事项：**
- 解锁操作需要正确的保险库密码
- 当前实现中密码存储在保险库文件中
- 如果密码错误，操作会失败

**首次使用解锁功能：**
- 默认密码：`amberlock`
- 建议立即修改！

---

### 4. 日志查看与过滤

#### 查看日志

日志列表显示最近 200 条操作记录，包含：
- ⏰ 时间戳
- 🔒/🔓 操作类型（lock/unlock）
- 📁 路径
- 🎚️ 完整性级别
- ✅/❌ 状态

#### 过滤日志

1. 在左侧"日志筛选"输入框中输入关键字
    - 支持路径、状态、级别等任意字段
    - 不区分大小写
2. 点击"刷新日志"或按 Enter
3. 日志列表将显示匹配的记录（最多 300 条）

**示例过滤查询：**
- `C:\Documents` - 查找特定目录的操作
- `error` - 查找失败的操作
- `High` - 查找 High 级别的操作
- `2025-01-01` - 查找特定日期的操作

---

## 🔧 高级功能

### 1. 卷根保护

**什么是卷根？**
- 磁盘根目录，如 `C:\`, `D:\`
- 包含系统关键文件和目录

**警告信息：**
选择卷根时会弹出警告对话框：
```
⚠️ 卷根保护警告

您正在尝试锁定卷根（如 C:\），这可能导致：

❌ 系统更新失败
❌ 应用程序无法安装
❌ 系统服务异常

建议仅使用【只读模式 + NW 策略】。

确定要继续吗？
```

**推荐做法：**
- 仅使用"只读"模式
- 不勾选"尝试 NR/NX"
- 确保了解潜在影响

---

### 2. 批量操作

**并发处理：**
- 默认并发度：4
- 可在配置文件中修改 `parallelism` 字段

**幂等性：**
- 重复锁定同一文件不会报错
- 已存在相同配置的对象会被跳过

**回滚机制：**
- 操作失败时自动回滚已修改的对象
- 恢复到原始状态

---

### 3. 进度跟踪

**进度信息：**
```
🔄 上锁中: 45.0% (45/100) - config.json
```

**显示内容：**
- 完成百分比
- 已处理/总数
- 当前处理的文件名

---

## ⚙️ 配置文件

### 位置

- Windows: `%APPDATA%\amberlock-settings.json`
- 示例: `C:\Users\YourName\AppData\Roaming\amberlock-settings.json`

### 配置项

```json
{
  "parallelism": 4,
  "default_mode": "ReadOnly",
  "default_level": "High",
  "enable_nr_nx": false,
  "log_path": "C:\\Users\\...\\amberlock-log.ndjson",
  "vault_path": "C:\\Users\\...\\amberlock-vault.bin",
  "shell_integration": false
}
```

| 字段 | 说明 | 默认值 |
|------|------|--------|
| `parallelism` | 并发度（同时处理的对象数） | `4` |
| `default_mode` | 默认保护模式 | `"ReadOnly"` |
| `default_level` | 默认完整性级别 | `"High"` |
| `enable_nr_nx` | 默认启用 NR/NX | `false` |
| `log_path` | 日志文件路径 | 自动 |
| `vault_path` | 保险库文件路径 | 自动 |
| `shell_integration` | 右键菜单集成（未来） | `false` |

---

## 🛡️ 安全建议

### 1. 密码管理

**修改默认密码：**

目前需要手动修改保险库文件，未来版本将提供 GUI 支持。

**临时方案（命令行）：**
```rust
// 创建一个小工具程序
use amberlock_auth::{create_vault, verify_password};

fn main() {
    let vault_path = "path/to/vault.bin";
    let old_blob = std::fs::read(vault_path).unwrap();
    
    // 验证旧密码
    if verify_password(&old_blob, "amberlock").unwrap() {
        // 创建新保险库
        let new_blob = create_vault("your_new_password").unwrap();
        std::fs::write(vault_path, new_blob).unwrap();
        println!("✅ 密码已修改");
    }
}
```

**密码强度建议：**
- 最低 12 字符
- 包含大小写字母、数字、符号
- 避免常见词汇
- 使用密码生成器

### 2. 权限管理

**最小权限原则：**
- 仅在需要时以管理员身份运行
- 完成操作后立即退出提升权限的会话

**权限检查：**
启动时会显示：
```
✅ 就绪 - 完整性级别: High
⚠️ 缺少 SeSecurityPrivilege，功能受限
ℹ️ 无法设置 System 级，将自动降级为 High
```

### 3. 操作记录

**日志文件：**
- 路径：`%LOCALAPPDATA%\amberlock-log.ndjson`
- 格式：NDJSON（每行一个 JSON 对象）
- 包含：时间、操作者、路径、结果

**审计支持：**
- 每次操作都会记录操作者的 SID
- 时间戳采用 UTC（ISO8601 格式）
- 可导出用于合规审计

---

## 🐛 故障排查

### 问题 1：程序无法启动

**症状：**
```
Error: Access is denied. (os error 5)
```

**解决方案：**
- 以管理员身份运行
- 检查防病毒软件是否阻止

### 问题 2：锁定操作总是失败

**症状：**
```
❌ 上锁失败: 0/10 失败
```

**可能原因：**
1. 文件正在被其他程序使用
2. 缺少必要权限
3. 文件系统不支持 NTFS

**解决方案：**
- 关闭占用文件的程序
- 确认以管理员身份运行
- 确保目标是 NTFS 文件系统

### 问题 3：解锁密码错误

**症状：**
```
❌ 解锁失败：密码错误或保险库损坏
```

**解决方案：**
1. 检查密码是否正确（默认：`amberlock`）
2. 尝试重新创建保险库：
   ```bash
   # 备份旧保险库
   copy %LOCALAPPDATA%\amberlock-vault.bin vault.bin.bak
   
   # 删除旧保险库
   del %LOCALAPPDATA%\amberlock-vault.bin
   
   # 重启程序（会自动创建新保险库）
   ```

### 问题 4：日志文件过大

**症状：**
日志文件占用数百 MB 空间

**解决方案：**
```bash
# 备份旧日志
copy %LOCALAPPDATA%\amberlock-log.ndjson log-backup.ndjson

# 清空日志（或使用文本编辑器删除旧记录）
echo. > %LOCALAPPDATA%\amberlock-log.ndjson
```

---

## 📚 常见问题 (FAQ)

### Q1: 锁定后文件是否可以删除？

**A**: 取决于锁定模式和调用者权限：

| 锁定模式 | 普通用户 | 管理员（High IL） | 系统服务 |
|---------|---------|------------------|---------|
| 只读 + High | ❌ 无法删除 | ✅ 可以删除 | ✅ 可以删除 |
| 只读 + System | ❌ 无法删除 | ❌ 无法删除 | ✅ 可以删除 |
| 封印 + High | ❌ 无法删除 | ✅ 可以删除 | ✅ 可以删除 |
| 封印 + System | ❌ 无法删除 | ❌ 无法删除 | ✅ 可以删除 |

### Q2: 是否支持网络共享文件？

**A**: 不支持。MIC 仅适用于本地 NTFS 文件系统。

### Q3: 重装系统后保险库还能用吗？

**A**: 不能。保险库使用 DPAPI 加密，绑定到当前用户和机器。重装系统后需要重新创建。

### Q4: 是否可以同时运行多个实例？

**A**: 可以，但不推荐。多个实例共享同一个日志文件，可能导致写入冲突。

### Q5: 如何验证文件是否已被锁定？

**方法一：查看属性**
1. 右键文件 → 属性 → 安全 → 高级
2. 查看"完整性级别"（如果存在）

**方法二：使用 PowerShell**
```powershell
# 查看完整性级别
icacls "C:\test\file.txt" | Select-String "Mandatory Label"
```

**方法三：查看日志**
在 AmberLock 日志查看器中搜索文件路径

---

## 🔮 未来功能

### 计划中的功能

- [ ] GUI 内密码修改功能
- [ ] 资源管理器右键菜单集成
- [ ] 系统托盘驻留
- [ ] 拖放支持
- [ ] 自定义 Slint 对话框
- [ ] 断点续执（大规模操作）
- [ ] 导出日志为 CSV
- [ ] 多语言支持

### 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📄 许可证

MIT OR Apache-2.0

---

**维护者**: Zelas2Xerath  
**版本**: 2.0.0  
**最后更新**: 2025-01-01